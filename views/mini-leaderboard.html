<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Mini Leaderboard Overlay</title>
    <link rel="stylesheet" href="/fonts.css">
    <link rel="stylesheet" href="/styles-mini-leaderboard.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/textfit@2.4.0/textFit.min.js"></script>
    <script src="/utils/driver-utils.js"></script>
</head>
<body>
    <div class="overlay-container">
        <!-- Sponsor -->
        <div class="sponsor">
            <div class="sponsor-rectangle"></div>
            <div class="sponsor-text-qatar">QATAR</div>
            <div class="sponsor-text-airways">AIRWAYS</div>
        </div>

        <!-- Leaderboard Container -->
        <div class="leaderboard-container">
            <!-- Background -->
            <div class="background">
                <!-- Main Rectangle -->
                <div class="background-rectangle-main"></div>
                <!-- Divider Rectangle -->
                <div class="background-rectangle-divider"></div>
                <!-- Decorations -->
                <img src="/images/mini-leaderboard/DecorationLeft.png" class="decoration-left" alt="">
                <img src="/images/mini-leaderboard/DecorationRight.png" class="decoration-right" alt="">
            </div>

            <!-- Driver Ahead -->
            <div class="driver-row driver-ahead">
                <div class="driver-name" id="name-ahead">PEREZ</div>
                <img src="/images/common/Knockout.png" class="knockout-overlay" alt="">
                <div class="position-number" id="position-ahead">1</div>
                <div class="position-stroke"></div>
            </div>

            <!-- Current Player (Highlighted) -->
            <div class="driver-row driver-current">
                <img src="/images/common/PlayerIndicator.png" class="player-indicator" alt="">
                <div class="driver-name" id="name-current">VERSTAPPEN</div>
                <img src="/images/common/Knockout.png" class="knockout-overlay" alt="">
                <div class="position-number" id="position-current">2</div>
            </div>

            <!-- Driver Behind -->
            <div class="driver-row driver-behind">
                <div class="driver-name" id="name-behind">LECLERC</div>
                <img src="/images/common/Knockout.png" class="knockout-overlay" alt="">
                <div class="position-number" id="position-behind">3</div>
                <div class="position-stroke"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        socket.emit('identify', 'Mini Leaderboard');
        
        // Element references
        const overlayContainer = document.querySelector('.overlay-container');
        const sponsorElement = document.querySelector('.sponsor');
        const positionAheadEl = document.getElementById('position-ahead');
        const nameAheadEl = document.getElementById('name-ahead');
        const positionCurrentEl = document.getElementById('position-current');
        const nameCurrentEl = document.getElementById('name-current');
        const positionBehindEl = document.getElementById('position-behind');
        const nameBehindEl = document.getElementById('name-behind');
        const driverAheadRow = document.querySelector('.driver-ahead');
        const driverBehindRow = document.querySelector('.driver-behind');
        const knockoutOverlayAhead = driverAheadRow.querySelector('.knockout-overlay');
        const knockoutOverlayCurrent = document.querySelector('.driver-current .knockout-overlay');
        const knockoutOverlayBehind = driverBehindRow.querySelector('.knockout-overlay');
        
        // Sponsor animation control
        let sponsorAnimation = null;
        let sponsorTimeout = null;
        
        // Data storage
        let aiDrivers = {};
        let customDrivers = [];
        let teamNames = {};
        let participants = []; // Store full participant data
        let participantLastNames = {};
        let playerIndex = null;
        let numActiveCars = 0;
        let formulaType = DriverUtils.FORMULA_TYPE.F1_MODERN;
        let sessionType = null;
        
        // Sponsor animation functions
        function startSponsorAnimation() {
            // Cancel any existing animation/timeout
            if (sponsorAnimation) sponsorAnimation.pause();
            if (sponsorTimeout) clearTimeout(sponsorTimeout);
            
            // Reset sponsor to visible
            sponsorElement.style.opacity = '1';
            
            // Start 6-second countdown to fade out
            sponsorTimeout = setTimeout(() => {
                sponsorAnimation = anime({
                    targets: sponsorElement,
                    opacity: 0,
                    duration: 200,
                    easing: 'easeOutQuad'
                });
            }, 6000);
        }
        
        function stopSponsorAnimation() {
            // Cancel any ongoing animation/timeout
            if (sponsorAnimation) sponsorAnimation.pause();
            if (sponsorTimeout) clearTimeout(sponsorTimeout);
            
            // Reset sponsor opacity after overlay transition completes (333ms + buffer)
            setTimeout(() => {
                sponsorElement.style.opacity = '1';
            }, 350);
        }
        
        // Handle overlay visibility from controller
        socket.on('overlay_config', (config) => {
            if (config.overlays && config.overlays['mini-leaderboard']) {
                if (config.overlays['mini-leaderboard'].visible) {
                    overlayContainer.classList.add('visible');
                    startSponsorAnimation();
                } else {
                    overlayContainer.classList.remove('visible');
                    stopSponsorAnimation();
                }
            }
        });
        
        // Load driver data using DriverUtils
        async function loadDriverData() {
            try {
                const data = await DriverUtils.loadDriverData(formulaType);
                customDrivers = data.customDrivers;
                teamNames = data.teamNames;
                console.log('[Mini Leaderboard] Loaded driver data:', customDrivers.length, 'custom drivers');
            } catch (error) {
                console.error('[Mini Leaderboard] Error loading driver data:', error);
            }
        }
        
        // Socket listeners
        socket.on('drivers_data', (data) => {
            aiDrivers = data;
            console.log('[Mini Leaderboard] AI Drivers loaded:', Object.keys(aiDrivers).length);
        });
        
        socket.on('f1_data', (data) => {
            const packetId = data.m_header?.m_packetId;
            
            // Session packet (ID 1) - Get player index, formula type, and session type
            if (packetId === 1) {
                playerIndex = data.m_header.m_playerCarIndex;
                sessionType = data.m_sessionType;
                
                if (data.m_formula !== undefined && data.m_formula !== formulaType) {
                    formulaType = data.m_formula;
                    console.log('[Mini Leaderboard] Formula type:', formulaType);
                    loadDriverData();
                }
            }
            
            // Participants packet (ID 4) - Get driver names using DriverUtils
            if (packetId === 4) {
                numActiveCars = data.m_numActiveCars || 0;
                participants = data.m_participants || [];
                participantLastNames = {};
                
                participants.forEach((participant, idx) => {
                    const driverName = DriverUtils.getDriverLastName(
                        participant,
                        aiDrivers,
                        customDrivers,
                        teamNames
                    );
                    participantLastNames[idx] = driverName;
                });
            }
            
            // Lap Data packet (ID 2) - Update positions
            if (packetId === 2 && playerIndex !== null && Array.isArray(data.m_lapData)) {
                const playerLapData = data.m_lapData[playerIndex];
                if (!playerLapData) return;
                
                const currentPosition = playerLapData.m_carPosition;
                
                // Calculate ahead and behind positions
                const positionAhead = currentPosition - 1;
                const positionBehind = currentPosition + 1;
                
                // Update current player
                positionCurrentEl.textContent = currentPosition;
                nameCurrentEl.textContent = participantLastNames[playerIndex] || '';
                textFit(nameCurrentEl, {
                    minFontSize: 17,
                    maxFontSize: 27,
                    multiLine: false,
                    alignHoriz: true,
                    alignVert: false,
                    widthOnly: true
                });
                
                // Update knockout overlay visibility for current player
                const isCurrentKnockout = DriverUtils.isInKnockoutZone(currentPosition, sessionType, numActiveCars);
                knockoutOverlayCurrent.style.display = isCurrentKnockout ? 'block' : 'none';
                positionCurrentEl.style.color = isCurrentKnockout ? 'rgb(255, 255, 255)' : 'rgb(0, 0, 0)';
                
                // Update driver ahead
                if (positionAhead >= 1) {
                    const aheadIdx = findDriverByPosition(data.m_lapData, positionAhead);
                    if (aheadIdx !== -1) {
                        driverAheadRow.style.display = 'flex';
                        positionAheadEl.textContent = positionAhead;
                        nameAheadEl.textContent = participantLastNames[aheadIdx] || '';
                        textFit(nameAheadEl, {
                            minFontSize: 14,
                            maxFontSize: 24,
                            multiLine: false,
                            alignHoriz: true,
                            alignVert: false,
                            widthOnly: true
                        });
                        
                        // Update knockout overlay visibility
                        knockoutOverlayAhead.style.display = DriverUtils.isInKnockoutZone(positionAhead, sessionType, numActiveCars) ? 'block' : 'none';
                    } else {
                        driverAheadRow.style.display = 'none';
                    }
                } else {
                    driverAheadRow.style.display = 'none';
                }
                
                // Update driver behind
                if (positionBehind <= numActiveCars) {
                    const behindIdx = findDriverByPosition(data.m_lapData, positionBehind);
                    if (behindIdx !== -1) {
                        driverBehindRow.style.display = 'flex';
                        positionBehindEl.textContent = positionBehind;
                        nameBehindEl.textContent = participantLastNames[behindIdx] || '';
                        textFit(nameBehindEl, {
                            minFontSize: 14,
                            maxFontSize: 24,
                            multiLine: false,
                            alignHoriz: true,
                            alignVert: false,
                            widthOnly: true
                        });
                        
                        // Update knockout overlay visibility
                        knockoutOverlayBehind.style.display = DriverUtils.isInKnockoutZone(positionBehind, sessionType, numActiveCars) ? 'block' : 'none';
                    } else {
                        driverBehindRow.style.display = 'none';
                    }
                } else {
                    driverBehindRow.style.display = 'none';
                }
            }
        });
        
        // Helper function to find driver index by position
        function findDriverByPosition(lapData, targetPosition) {
            return lapData.findIndex(lap => lap.m_carPosition === targetPosition);
        }
        
        console.log('[Mini Leaderboard] Overlay loaded');
    </script>
</body>
</html>
