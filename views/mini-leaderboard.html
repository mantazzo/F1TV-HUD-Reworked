<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Mini Leaderboard Overlay</title>
    <link rel="stylesheet" href="/fonts.css">
    <link rel="stylesheet" href="/styles-mini-leaderboard.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/textfit@2.4.0/textFit.min.js"></script>
</head>
<body>
    <div class="overlay-container">
        <!-- Sponsor -->
        <div class="sponsor">
            <div class="sponsor-rectangle"></div>
            <div class="sponsor-text-qatar">QATAR</div>
            <div class="sponsor-text-airways">AIRWAYS</div>
        </div>

        <!-- Leaderboard Container -->
        <div class="leaderboard-container">
            <!-- Background -->
            <div class="background">
                <!-- Main Rectangle -->
                <div class="background-rectangle-main"></div>
                <!-- Divider Rectangle -->
                <div class="background-rectangle-divider"></div>
                <!-- Decorations -->
                <img src="/images/mini-leaderboard/DecorationLeft.png" class="decoration-left" alt="">
                <img src="/images/mini-leaderboard/DecorationRight.png" class="decoration-right" alt="">
            </div>

            <!-- Driver Ahead -->
            <div class="driver-row driver-ahead">
                <div class="driver-name" id="name-ahead">PEREZ</div>
                <img src="/images/common/Knockout.png" class="knockout-overlay" alt="">
                <div class="position-number" id="position-ahead">1</div>
                <div class="position-stroke"></div>
            </div>

            <!-- Current Player (Highlighted) -->
            <div class="driver-row driver-current">
                <img src="/images/common/PlayerIndicator.png" class="player-indicator" alt="">
                <div class="driver-name" id="name-current">VERSTAPPEN</div>
                <img src="/images/common/Knockout.png" class="knockout-overlay" alt="">
                <div class="position-number" id="position-current">2</div>
            </div>

            <!-- Driver Behind -->
            <div class="driver-row driver-behind">
                <div class="driver-name" id="name-behind">LECLERC</div>
                <img src="/images/common/Knockout.png" class="knockout-overlay" alt="">
                <div class="position-number" id="position-behind">3</div>
                <div class="position-stroke"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        socket.emit('identify', 'Mini Leaderboard');
        
        // Element references
        const overlayContainer = document.querySelector('.overlay-container');
        const sponsorElement = document.querySelector('.sponsor');
        const positionAheadEl = document.getElementById('position-ahead');
        const nameAheadEl = document.getElementById('name-ahead');
        const positionCurrentEl = document.getElementById('position-current');
        const nameCurrentEl = document.getElementById('name-current');
        const positionBehindEl = document.getElementById('position-behind');
        const nameBehindEl = document.getElementById('name-behind');
        const driverAheadRow = document.querySelector('.driver-ahead');
        const driverBehindRow = document.querySelector('.driver-behind');
        const knockoutOverlayAhead = driverAheadRow.querySelector('.knockout-overlay');
        const knockoutOverlayCurrent = document.querySelector('.driver-current .knockout-overlay');
        const knockoutOverlayBehind = driverBehindRow.querySelector('.knockout-overlay');
        
        // Sponsor animation control
        let sponsorAnimation = null;
        let sponsorTimeout = null;
        
        // Session type constants
        const SESSION_TYPE = {
            QUALIFYING_1: 5,
            QUALIFYING_2: 6,
            SPRINT_SHOOTOUT_1: 10,
            SPRINT_SHOOTOUT_2: 11
        };
        
        // Knockout zone position thresholds
        const KNOCKOUT_ZONE_POSITIONS = {
            Q1_20_CARS: 15,  // Positions 16-20 are knockout zone
            Q1_22_CARS: 16,  // Positions 17-22 are knockout zone
            Q2: 10           // Positions 11+ are knockout zone
        };
        
        // Data storage
        let aiDrivers = {};
        let customDrivers = [];
        let teamNames = {};
        let participantData = {};
        let participantLastNames = {};
        let playerIndex = null;
        let numActiveCars = 0;
        let formulaType = null;
        let sessionType = null;
        
        // Sponsor animation functions
        function startSponsorAnimation() {
            // Cancel any existing animation/timeout
            if (sponsorAnimation) sponsorAnimation.pause();
            if (sponsorTimeout) clearTimeout(sponsorTimeout);
            
            // Reset sponsor to visible
            sponsorElement.style.opacity = '1';
            
            // Start 6-second countdown to fade out
            sponsorTimeout = setTimeout(() => {
                sponsorAnimation = anime({
                    targets: sponsorElement,
                    opacity: 0,
                    duration: 200,
                    easing: 'easeOutQuad'
                });
            }, 6000);
        }
        
        function stopSponsorAnimation() {
            // Cancel any ongoing animation/timeout
            if (sponsorAnimation) sponsorAnimation.pause();
            if (sponsorTimeout) clearTimeout(sponsorTimeout);
            
            // Reset sponsor opacity after overlay transition completes (333ms + buffer)
            setTimeout(() => {
                sponsorElement.style.opacity = '1';
            }, 350);
        }
        
        // Handle overlay visibility from controller
        socket.on('overlay_config', (config) => {
            if (config.overlays && config.overlays['mini-leaderboard']) {
                if (config.overlays['mini-leaderboard'].visible) {
                    overlayContainer.classList.add('visible');
                    startSponsorAnimation();
                } else {
                    overlayContainer.classList.remove('visible');
                    stopSponsorAnimation();
                }
            }
        });
        
        // Load JSON files
        async function loadJsonFiles() {
            try {
                const [teamsResponse, customDriversResponse] = await Promise.all([
                    fetch('/data/DefaultTeams.json'),
                    formulaType === 0 ? fetch('/data/CustomF1Drivers.json') : 
                    formulaType === 1 ? fetch('/data/CustomF2Drivers.json') : 
                    Promise.resolve({ json: () => [] })
                ]);
                
                teamNames = await teamsResponse.json();
                customDrivers = await customDriversResponse.json();
                console.log('[Mini Leaderboard] JSON files loaded');
            } catch (error) {
                console.error('[Mini Leaderboard] Error loading JSON files:', error);
            }
        }
        
        // Match custom driver
        function matchCustomDriver(participant) {
            if (!Array.isArray(customDrivers) || customDrivers.length === 0 || participant.m_driverId !== 255) {
                return null;
            }
            
            const raceNumber = participant.m_raceNumber;
            const teamId = participant.m_teamId;
            const name = participant.m_name;
            
            // Priority 1: Exact name match
            let match = customDrivers.find(d => d.MatchName && d.MatchName === name);
            if (match) return match;
            
            // Priority 2: Race number + team match
            const teamData = teamNames[teamId];
            const teamName = teamData?.Name || '';
            if (teamName) {
                match = customDrivers.find(d => 
                    d.RaceNumber === raceNumber && 
                    d.Team && d.Team.toLowerCase() === teamName.toLowerCase()
                );
                if (match) return match;
            }
            
            // Priority 3: Race number only
            match = customDrivers.find(d => d.RaceNumber === raceNumber);
            if (match) return match;
            
            return null;
        }
        
        // Function to check if position is in knockout zone
        function isInKnockoutZone(position) {
            const isQ1 = [SESSION_TYPE.QUALIFYING_1, SESSION_TYPE.SPRINT_SHOOTOUT_1].includes(sessionType);
            const isQ2 = [SESSION_TYPE.QUALIFYING_2, SESSION_TYPE.SPRINT_SHOOTOUT_2].includes(sessionType);
            
            if (isQ1) {
                const threshold = numActiveCars === 20 ? KNOCKOUT_ZONE_POSITIONS.Q1_20_CARS : KNOCKOUT_ZONE_POSITIONS.Q1_22_CARS;
                return position > threshold;
            } else if (isQ2) {
                return position > KNOCKOUT_ZONE_POSITIONS.Q2;
            }
            
            return false;
        }
        
        // Socket listeners
        socket.on('drivers_data', (data) => {
            aiDrivers = data;
            console.log('[Mini Leaderboard] AI Drivers loaded:', Object.keys(aiDrivers).length);
        });
        
        socket.on('f1_data', (data) => {
            const packetId = data.m_header?.m_packetId;
            
            // Session packet (ID 1) - Get player index, formula type, and session type
            if (packetId === 1) {
                playerIndex = data.m_header.m_playerCarIndex;
                sessionType = data.m_sessionType;
                
                if (data.m_formula !== undefined && data.m_formula !== formulaType) {
                    formulaType = data.m_formula;
                    loadJsonFiles();
                }
            }
            
            // Participants packet (ID 4) - Get driver names
            if (packetId === 4) {
                numActiveCars = data.m_numActiveCars || 0;
                
                if (Array.isArray(data.m_participants)) {
                    data.m_participants.forEach((participant, idx) => {
                        participantData[idx] = participant;
                        
                        if (participant.m_driverId === 255) {
                            // Custom driver
                            const customMatch = matchCustomDriver(participant);
                            if (customMatch) {
                                participantLastNames[idx] = customMatch.LastName || customMatch.DisplayName || 'PLAYER';
                            } else {
                                participantLastNames[idx] = participant.m_name || 'PLAYER';
                            }
                        } else if (aiDrivers && aiDrivers[participant.m_driverId]) {
                            // AI driver
                            participantLastNames[idx] = aiDrivers[participant.m_driverId].lastName || 'UNKNOWN';
                        } else {
                            participantLastNames[idx] = 'UNKNOWN';
                        }
                    });
                }
            }
            
            // Lap Data packet (ID 2) - Update positions
            if (packetId === 2 && playerIndex !== null && Array.isArray(data.m_lapData)) {
                const playerLapData = data.m_lapData[playerIndex];
                if (!playerLapData) return;
                
                const currentPosition = playerLapData.m_carPosition;
                
                // Calculate ahead and behind positions
                const positionAhead = currentPosition - 1;
                const positionBehind = currentPosition + 1;
                
                // Update current player
                positionCurrentEl.textContent = currentPosition;
                nameCurrentEl.textContent = participantLastNames[playerIndex] || '';
                textFit(nameCurrentEl, {
                    minFontSize: 17,
                    maxFontSize: 27,
                    multiLine: false,
                    alignHoriz: true,
                    alignVert: false,
                    widthOnly: true
                });
                
                // Update knockout overlay visibility for current player
                const isCurrentKnockout = isInKnockoutZone(currentPosition);
                knockoutOverlayCurrent.style.display = isCurrentKnockout ? 'block' : 'none';
                positionCurrentEl.style.color = isCurrentKnockout ? 'rgb(255, 255, 255)' : 'rgb(0, 0, 0)';
                
                // Update driver ahead
                if (positionAhead >= 1) {
                    const aheadIdx = findDriverByPosition(data.m_lapData, positionAhead);
                    if (aheadIdx !== -1) {
                        driverAheadRow.style.display = 'flex';
                        positionAheadEl.textContent = positionAhead;
                        nameAheadEl.textContent = participantLastNames[aheadIdx] || '';
                        textFit(nameAheadEl, {
                            minFontSize: 14,
                            maxFontSize: 24,
                            multiLine: false,
                            alignHoriz: true,
                            alignVert: false,
                            widthOnly: true
                        });
                        
                        // Update knockout overlay visibility
                        knockoutOverlayAhead.style.display = isInKnockoutZone(positionAhead) ? 'block' : 'none';
                    } else {
                        driverAheadRow.style.display = 'none';
                    }
                } else {
                    driverAheadRow.style.display = 'none';
                }
                
                // Update driver behind
                if (positionBehind <= numActiveCars) {
                    const behindIdx = findDriverByPosition(data.m_lapData, positionBehind);
                    if (behindIdx !== -1) {
                        driverBehindRow.style.display = 'flex';
                        positionBehindEl.textContent = positionBehind;
                        nameBehindEl.textContent = participantLastNames[behindIdx] || '';
                        textFit(nameBehindEl, {
                            minFontSize: 14,
                            maxFontSize: 24,
                            multiLine: false,
                            alignHoriz: true,
                            alignVert: false,
                            widthOnly: true
                        });
                        
                        // Update knockout overlay visibility
                        knockoutOverlayBehind.style.display = isInKnockoutZone(positionBehind) ? 'block' : 'none';
                    } else {
                        driverBehindRow.style.display = 'none';
                    }
                } else {
                    driverBehindRow.style.display = 'none';
                }
            }
        });
        
        // Helper function to find driver index by position
        function findDriverByPosition(lapData, targetPosition) {
            return lapData.findIndex(lap => lap.m_carPosition === targetPosition);
        }
        
        console.log('[Mini Leaderboard] Overlay loaded');
    </script>
</body>
</html>
