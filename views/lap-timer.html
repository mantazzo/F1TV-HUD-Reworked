<!DOCTYPE html>
<html>
<head>
    <title>F1 Lap Timer Overlay</title>
    <link rel="stylesheet" href="/fonts.css">
    <link rel="stylesheet" href="/styles-lap-timer.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>
<body>
    <div class="overlay-container">
        <div class="position-layer">1</div>
        <div class="team-logo-layer"></div>
        <div class="driver-name-layer">VERSTAPPEN</div>
        <div class="tyre-compound-layer">S</div>
        <div id="sector1-delta" class="sector-display-layer">27.8</div>
        <div id="sector2-delta" class="sector-display-layer">1:02.6</div>
        <div id="last-lap-delta" class="sector-display-layer">--:--.-</div>
        <div id="timer-background"></div>
        <div id="sectors-background"></div>
        <div id="separator"></div>
        <div id="lap-time" class="lap-time-layer">1:34.4</div>
        <div id="last-lap-time" class="last-lap-time-layer">Last: --:--.-</div>
        <div id="best-lap-time" class="best-lap-time-layer">Best: --:--.-</div>
        <div id="lap-time-comparison" class="lap-time-comparison-layer">1:39.432</div>
        <div id="lap-time-comparison-name" class="lap-time-comparison-name-layer">MAX VERSTAPPEN</div>
        <div id="sector-line"></div>
        <div id="sector1-text" class="sector1-text-layer">S1</div>
        <div id="sector2-text" class="sector2-text-layer">S2</div>
        <div id="sector3-text" class="sector3-text-layer">S3</div>
    </div>
    <script>
        const socket = io();
        const lapTimeElement = document.getElementById('lap-time');
        const lastLapTimeElement = document.getElementById('last-lap-time');
        const bestLapTimeElement = document.getElementById('best-lap-time');
        const lapTimeComparisonElement = document.getElementById('lap-time-comparison');
        const lapTimeComparisonNameElement = document.getElementById('lap-time-comparison-name');
        const separatorElement = document.getElementById('separator');
        const sector1TextElement = document.getElementById('sector1-text');
        const sector2TextElement = document.getElementById('sector2-text');
        const sector3TextElement = document.getElementById('sector3-text');
        const positionElement = document.querySelector('.position-layer');
        const driverNameElement = document.querySelector('.driver-name-layer');
        const tyreCompoundElement = document.querySelector('.tyre-compound-layer');
        const teamLogoElement = document.querySelector('.team-logo-layer');
        const sector1DeltaElement = document.getElementById('sector1-delta');
        const sector2DeltaElement = document.getElementById('sector2-delta');
        const lastLapDeltaElement = document.getElementById('last-lap-delta');

        let currentLapTime = '1:34.4';
        let lastLapTime = '1:36.426';
        let bestLapTime = '--:--.-';
        let lapTimeComparison = '1:39.432';
        let lapTimeComparisonName = 'MAX VERSTAPPEN';
        let transitionValue = '1:39.432'; // New variable for transition display
        let isTransitioning = false; // Flag to track transition state
        let position = '1';
        let driverName = 'VERSTAPPEN';
        let tyreCompound = 'S';
        let sessionType = 0;
        let formulaType = 0;
        let leaderCarIdx = -1;
        let targetCarIdx = -1;
        let numActiveCars = 20;
        let currentLapNum = 0;
        let playerCarIdx = -1;
        let participantNames = {};
        let teamNames = {};
        let customDrivers = [];
        let aiDrivers = {};
        let prevLastLapTimeMS = -1;
        let refSector1TimeMS = -1;
        let refSector2TimeMS = -1;
        let refLastLapTimeMS = -1;
        let prevSector1TimeMS = -1;
        let prevSector2TimeMS = -1;
        let canUpdateReference = true;
        let prevSector = -1;
        let sectorTimeout = null;

        async function loadJsonFiles() {
            try {
                const promises = [
                    fetch('/data/DefaultTeams.json'),
                    fetch('/data/DefaultAIDrivers.json')
                ];
                if (formulaType === 0) {
                    promises.push(fetch('/data/CustomF1Drivers.json'));
                } else if (formulaType === 2) {
                    promises.push(fetch('/data/CustomF2Drivers.json'));
                }
                const responses = await Promise.all(promises.map(p => p.catch(() => null)));
                teamNames = responses[0] ? await responses[0].json() : {};
                aiDrivers = responses[1] ? await responses[1].json() : {};
                if (responses[2]) {
                    const customDriversData = await responses[2].json();
                    customDrivers = Array.isArray(customDriversData) ? customDriversData : [];
                }
            } catch (error) {
                console.error('Error loading JSON files:', error);
                customDrivers = [];
            }
        }

        function getAbbreviation(displayName) {
            const words = displayName.split(' ');
            const lastWord = words[words.length - 1];
            return lastWord.slice(0, 3).toUpperCase();
        }

        function matchCustomDriver(participant) {
            const raceNumber = participant.m_raceNumber;
            const name = participant.m_name;
            const teamId = participant.m_teamId;
            const team = teamNames[teamId] ? teamNames[teamId].ShortName : `Team_${teamId}`;

            for (let driver of customDrivers) {
                if (driver.Name && driver.Name.toUpperCase() === name.toUpperCase()) {
                    return { displayName: driver.DisplayName, abbreviation: driver.Abbreviation || getAbbreviation(driver.DisplayName) };
                }
                if (driver.RaceNumber && driver.Team && driver.RaceNumber === raceNumber && driver.Team === team) {
                    return { displayName: driver.DisplayName, abbreviation: driver.Abbreviation || getAbbreviation(driver.DisplayName) };
                }
                if (driver.RaceNumber && driver.RaceNumber === raceNumber) {
                    return { displayName: driver.DisplayName, abbreviation: driver.Abbreviation || getAbbreviation(driver.DisplayName) };
                }
            }
            return { displayName: `${team} #${raceNumber}`, abbreviation: getAbbreviation(`${team} #${raceNumber}`) };
        }

        function getLastName(displayName) {
            const words = displayName.split(' ');
            return words.length > 1 ? words.slice(1).join(' ') : displayName;
        }

        function formatTime(milliseconds) {
            if (milliseconds < 10000) {
                const seconds = Math.floor(milliseconds / 1000);
                const ms = Math.floor(milliseconds % 1000 / 100);
                return `${seconds}.${ms}`;
            } else if (milliseconds < 60000) {
                const seconds = Math.floor(milliseconds / 1000);
                const ms = Math.floor(milliseconds % 1000 / 100);
                return `${String(seconds).padStart(2, '0')}.${ms}`;
            } else {
                const minutes = Math.floor(milliseconds / 60000);
                const seconds = Math.floor((milliseconds % 60000) / 1000);
                const ms = Math.floor(milliseconds % 1000 / 100);
                return `${minutes}:${String(seconds).padStart(2, '0')}.${ms}`;
            }
        }

        function formatComparisonTime(milliseconds) {
            if (milliseconds < 60000) {
                const seconds = Math.floor(milliseconds / 1000);
                const ms = milliseconds % 1000;
                return `${seconds}.${String(ms).padStart(3, '0')}`;
            } else {
                const minutes = Math.floor(milliseconds / 60000);
                const seconds = Math.floor((milliseconds % 60000) / 1000);
                const ms = milliseconds % 1000;
                return `${minutes}:${String(seconds).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
            }
        }

        function calculateSectorTime(minutesPart, msPart) {
            return minutesPart * 60000 + msPart;
        }

        function calculateCombinedSectorTime(s1MinutesPart, s1MsPart, s2MinutesPart, s2MsPart) {
            return calculateSectorTime(s1MinutesPart, s1MsPart) + calculateSectorTime(s2MinutesPart, s2MsPart);
        }

        function updateLapDisplay() {
            lapTimeElement.textContent = currentLapTime;
            lastLapTimeElement.textContent = lastLapTime;
            bestLapTimeElement.textContent = `Best: ${bestLapTime}`;
            lapTimeComparisonElement.textContent = transitionValue; // Use transitionValue for display
            lapTimeComparisonNameElement.textContent = lapTimeComparisonName.toUpperCase();
            sector1TextElement.textContent = 'S1';
            sector2TextElement.textContent = 'S2';
            sector3TextElement.textContent = 'S3';
            positionElement.textContent = position;
            driverNameElement.textContent = driverName.toUpperCase();
            tyreCompoundElement.textContent = tyreCompound;
            // Apply color based on tyre compound
            switch (tyreCompound) {
                case 'S':
                    tyreCompoundElement.style.color = '#FF0000'; // Soft
                    break;
                case 'M':
                    tyreCompoundElement.style.color = '#FFFF00'; // Medium
                    break;
                case 'H':
                    tyreCompoundElement.style.color = '#FFFFFF'; // Hard
                    break;
                case 'I':
                    tyreCompoundElement.style.color = '#00FF00'; // Intermediate
                    break;
                case 'W':
                    tyreCompoundElement.style.color = '#018dd2'; // Wet
                    break;
                case 'SS':
                    tyreCompoundElement.style.color = '#800080'; // Supersoft
                    break;
                default:
                    tyreCompoundElement.textContent = '?';
                    tyreCompoundElement.style.color = '#808080'; // Unknown
            }

            if (currentLapTime.includes(':')) {
                const [minutes] = currentLapTime.split(':').map(Number);
                if (minutes >= 1) {
                    lapTimeElement.style.left = '38px';
                } else {
                    lapTimeElement.style.left = '65px';
                }
            } else if (parseInt(currentLapTime) < 10) {
                lapTimeElement.style.left = '115px';
            } else {
                lapTimeElement.style.left = '65px';
            }
        }

        function updateTeamLogo(teamId) {
            const teamData = teamNames[teamId] || { Logo: 'red_bull_racing.png' };
            const logoPath = `/images/team-logos/${teamData.Logo}`;
            teamLogoElement.style.backgroundImage = `url(${logoPath})`;
            const img = new Image();
            img.onerror = () => teamLogoElement.style.backgroundImage = `url(/images/team-logos/red_bull_racing.png)`;
            img.src = logoPath;
        }

        socket.on('f1_data', (data) => {
            if (data.m_header.m_packetId === 1) {
                sessionType = data.m_sessionType;
                formulaType = data.m_formula;
                if (!customDrivers.length) loadJsonFiles();
            } else if (data.m_header.m_packetId === 2) {
                const playerIndex = data.m_header.m_playerCarIndex;
                const lapData = data.m_lapData[playerIndex];

                if (lapData) {
                    const newLapTime = lapData.m_currentLapTimeInMS;
                    if (newLapTime > 0) currentLapTime = formatTime(newLapTime);

                    const lastLapTimeMS = lapData.m_lastLapTimeInMS;
                    if (lastLapTimeMS > 0) {
                        lastLapTime = formatComparisonTime(lastLapTimeMS);
                        const newCurrentLapNum = lapData.m_currentLapNum || 0;
                        if ((lastLapTimeMS !== prevLastLapTimeMS || newCurrentLapNum !== currentLapNum) && newLapTime > 2000) {
                            prevLastLapTimeMS = lastLapTimeMS;
                            currentLapNum = newCurrentLapNum;
                            lastLapTimeElement.style.top = `${parseInt(getComputedStyle(lastLapTimeElement).top) || 57}px`;
                            lastLapTimeElement.style.opacity = '0';
                            [lapTimeComparisonElement, lapTimeComparisonNameElement, separatorElement, lapTimeElement].forEach(el => {
                                el.style.top = `${parseInt(getComputedStyle(el).top) || 0}px`;
                                el.style.opacity = '1';
                            });
                            anime.timeline({
                                easing: 'easeInOutQuad'
                            })
                            .add({
                                targets: lastLapTimeElement,
                                top: function(el) { return (parseInt(getComputedStyle(el).top) || 57) + 80 + 'px'; },
                                opacity: 1,
                                duration: 333
                            });
                            anime({
                                targets: [lapTimeComparisonElement, lapTimeComparisonNameElement, separatorElement, lapTimeElement],
                                top: function(el) { return (parseInt(getComputedStyle(el).top) || 0) - 100 + 'px'; },
                                opacity: 0,
                                duration: 333,
                                easing: 'easeInOutQuad'
                            });
                            setTimeout(() => {
                                anime({
                                    targets: lastLapTimeElement,
                                    top: function(el) { return (parseInt(getComputedStyle(el).top) || 137) - 80 + 'px'; },
                                    opacity: 0,
                                    duration: 333,
                                    easing: 'easeInOutQuad'
                                });
                                anime({
                                    targets: [lapTimeComparisonElement, lapTimeComparisonNameElement, separatorElement, lapTimeElement],
                                    top: function(el) { return (parseInt(getComputedStyle(el).top) || -100) + 100 + 'px'; },
                                    opacity: 1,
                                    duration: 333,
                                    easing: 'easeInOutQuad'
                                });
                            }, 5667);
                        }

                        // Last Lap Delta logic with canUpdateReference check
                        if ((lastLapTimeMS !== prevLastLapTimeMS || newCurrentLapNum !== currentLapNum) && newCurrentLapNum > 1 && canUpdateReference) {
                            lapTimeElement.style.opacity = '0';
                            lastLapDeltaElement.style.opacity = '1';
                            canUpdateReference = false; // Lock reference updates
                            const delta = lastLapTimeMS - refLastLapTimeMS;
                            if (sessionType === 18 && refLastLapTimeMS > 0) {
                                lastLapDeltaElement.textContent = `${delta >= 0 ? '+' : '-'}${formatComparisonTime(Math.abs(delta))}`;
                                lastLapDeltaElement.style.color = delta >= 0 ? '#FDD30A' : 'lime';
                            } else if ([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17].includes(sessionType) && refLastLapTimeMS > 0) {
                                lastLapDeltaElement.textContent = `${delta >= 0 ? '+' : '-'}${formatComparisonTime(Math.abs(delta))}`;
                                lastLapDeltaElement.style.color = delta >= 0 ? '#FDD30A' : 'lime';
                            } else {
                                lastLapDeltaElement.textContent = formatComparisonTime(lastLapTimeMS);
                                lastLapDeltaElement.style.color = '#ffffff';
                            }
                            setTimeout(() => {
                                lastLapDeltaElement.style.opacity = '0';
                                canUpdateReference = true;
                            }, 2000);
                        }
                    }

                    position = lapData.m_carPosition || '1';
                    playerCarIdx = playerIndex;
                    driverName = getLastName(participantNames[playerCarIdx] || 'UNKNOWN');

                    // Dynamically update lap time comparison based on current sector
                    const currentSector = lapData.m_sector;
                    if (refSector1TimeMS > 0 && currentSector === 0) {
                        lapTimeComparison = formatComparisonTime(refSector1TimeMS);
                    } else if (refSector2TimeMS > 0 && currentSector === 1) {
                        lapTimeComparison = formatComparisonTime(refSector2TimeMS);
                    } else if (refLastLapTimeMS > 0 && currentSector === 2) {
                        lapTimeComparison = formatComparisonTime(refLastLapTimeMS);
                    } else {
                        lapTimeComparison = '--:--.-'; // Fallback to avoid "00.000"
                    }

                    // Trigger transition before switching text
                    if (prevSector !== currentSector) {
                        if (sectorTimeout) clearTimeout(sectorTimeout);
                        isTransitioning = true;
                        transitionValue = lapTimeComparisonElement.textContent; // Hold current display
                        sectorTimeout = setTimeout(() => {
                            transitionValue = lapTimeComparison; // Switch to new value after delay
                            isTransitioning = false;
                            updateLapDisplay();
                        }, 4000);
                    } else if (!isTransitioning) {
                        transitionValue = lapTimeComparison; // Update immediately if no transition
                        updateLapDisplay();
                    }

                    prevSector = currentSector;

                    // Restore missing targetCarIdx logic
                    for (let i = 0; i < data.m_lapData.length; i++) {
                        if (data.m_lapData[i].m_carPosition === 1) {
                            leaderCarIdx = i;
                            break;
                        }
                    }
                    targetCarIdx = leaderCarIdx;
                    if ([5, 10].includes(sessionType)) {
                        const threshold = numActiveCars === 20 ? 15 : 16;
                        if (position > threshold) {
                            for (let i = 0; i < data.m_lapData.length; i++) {
                                if (data.m_lapData[i].m_carPosition === threshold) {
                                    targetCarIdx = i;
                                    break;
                                }
                            }
                        }
                    } else if ([6, 11].includes(sessionType)) {
                        if (position > 10) {
                            for (let i = 0; i < data.m_lapData.length; i++) {
                                if (data.m_lapData[i].m_carPosition === 10) {
                                    targetCarIdx = i;
                                    break;
                                }
                            }
                        }
                    } else if ([15, 16, 17].includes(sessionType)) {
                        targetCarIdx = playerCarIdx;
                    }

                    if (lastLapTime !== '--:--.-') {
                        anime({
                            targets: lapTimeElement,
                            color: ['#ffffff', '#00ff00', '#ffffff'],
                            duration: 500,
                            easing: 'easeInOutQuad'
                        });
                    }

                    // Sector 1 delta logic with display mechanics
                    const sector1TimeMS = calculateSectorTime(lapData.m_sector1TimeMinutesPart, lapData.m_sector1TimeMSPart);
                    if (sector1TimeMS > 0 && sector1TimeMS !== prevSector1TimeMS) {
                        prevSector1TimeMS = sector1TimeMS;
                        lapTimeElement.style.opacity = '0';
                        sector1DeltaElement.style.opacity = '1';
                        if (sessionType === 18 && refSector1TimeMS > 0) {
                            const delta = sector1TimeMS - refSector1TimeMS;
                            sector1DeltaElement.textContent = `${delta >= 0 ? '+' : '-'}${formatComparisonTime(Math.abs(delta))}`;
                            sector1DeltaElement.style.color = delta >= 0 ? '#FDD30A' : 'lime';
                        } else if ([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17].includes(sessionType) && refSector1TimeMS > 0) {
                            const delta = sector1TimeMS - refSector1TimeMS;
                            sector1DeltaElement.textContent = `${delta >= 0 ? '+' : '-'}${formatComparisonTime(Math.abs(delta))}`;
                            sector1DeltaElement.style.color = delta >= 0 ? '#FDD30A' : 'lime';
                        } else {
                            sector1DeltaElement.textContent = formatComparisonTime(sector1TimeMS);
                            sector1DeltaElement.style.color = '#ffffff';
                        }
                        setTimeout(() => {
                            sector1DeltaElement.style.opacity = '0';
                            lapTimeElement.style.opacity = '1';
                        }, 4000);
                    }

                    // Sector 2 delta logic with display mechanics
                    const sector2TimeMS = calculateSectorTime(lapData.m_sector2TimeMinutesPart, lapData.m_sector2TimeMSPart);
                    const combinedTimeMS = calculateCombinedSectorTime(lapData.m_sector1TimeMinutesPart, lapData.m_sector1TimeMSPart, lapData.m_sector2TimeMinutesPart, lapData.m_sector2TimeMSPart);
                    if (sector2TimeMS > 0 && combinedTimeMS !== prevSector2TimeMS) {
                        prevSector2TimeMS = combinedTimeMS;
                        lapTimeElement.style.opacity = '0';
                        sector2DeltaElement.style.opacity = '1';
                        if (sessionType === 18 && refSector2TimeMS > 0) {
                            const delta = combinedTimeMS - refSector2TimeMS;
                            sector2DeltaElement.textContent = `${delta >= 0 ? '+' : '-'}${formatComparisonTime(Math.abs(delta))}`;
                            sector2DeltaElement.style.color = delta >= 0 ? '#FDD30A' : 'lime';
                        } else if ([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17].includes(sessionType) && refSector2TimeMS > 0) {
                            const delta = combinedTimeMS - refSector2TimeMS;
                            sector2DeltaElement.textContent = `${delta >= 0 ? '+' : '-'}${formatComparisonTime(Math.abs(delta))}`;
                            sector2DeltaElement.style.color = delta >= 0 ? '#FDD30A' : 'lime';
                        } else {
                            sector2DeltaElement.textContent = formatComparisonTime(combinedTimeMS);
                            sector2DeltaElement.style.color = '#ffffff';
                        }
                        setTimeout(() => {
                            sector2DeltaElement.style.opacity = '0';
                            lapTimeElement.style.opacity = '1';
                        }, 4000);
                    }

                    updateLapDisplay();
                }
            } else if (data.m_header.m_packetId === 4) {
                numActiveCars = data.m_participants.length;
                participantNames = {};
                for (let i = 0; i < numActiveCars && i < data.m_participants.length; i++) {
                    const participant = data.m_participants[i];
                    const index = participant.m_participantIndex !== undefined ? participant.m_participantIndex : i;
                    const driverId = participant.m_driverId;
                    if (driverId === 255) {
                        const customMatch = matchCustomDriver(participant);
                        participantNames[index] = getLastName(customMatch.displayName);
                    } else {
                        const aiDriver = aiDrivers[driverId];
                        participantNames[index] = getLastName(aiDriver ? aiDriver.DisplayName : 'UNKNOWN_AI');
                    }
                    if (i === playerCarIdx) updateTeamLogo(participant.m_teamId);
                }
                updateLapDisplay();
            } else if (data.m_header.m_packetId === 7) {
                const playerIndex = data.m_header.m_playerCarIndex;
                const carStatus = data.m_carStatusData[playerIndex];
                if (carStatus) {
                    const visualTyreCompound = carStatus.m_visualTyreCompound;
                    switch (visualTyreCompound) {
                        case 16: // F1 Soft
                            tyreCompound = 'S';
                            break;
                        case 17: // F1 Medium
                            tyreCompound = 'M';
                            break;
                        case 18: // F1 Hard
                            tyreCompound = 'H';
                            break;
                        case 7: // F1 Intermediate
                            tyreCompound = 'I';
                            break;
                        case 8: // F1 Wet
                            tyreCompound = 'W';
                            break;
                        case 19: // F2 Supersoft
                            tyreCompound = 'SS';
                            break;
                        case 20: // F2 Soft
                            tyreCompound = 'S';
                            break;
                        case 21: // F2 Medium
                            tyreCompound = 'M';
                            break;
                        case 22: // F2 Hard
                            tyreCompound = 'H';
                            break;
                        case 15: // F2 Wet
                            tyreCompound = 'W';
                            break;
                        default:
                            tyreCompound = '?';
                    }
                    updateLapDisplay();
                }
            } else if (data.m_header.m_packetId === 14) {
                const playerIndex = data.m_header.m_playerCarIndex;
                const timeTrialData = data;

                if (timeTrialData && sessionType === 18 && canUpdateReference) {
                    const personalBestTime = timeTrialData.m_personalBestDataSet.m_lapTimeInMS;
                    if (personalBestTime != null && personalBestTime > 0) {
                        lapTimeComparisonName = getLastName('PERSONAL BEST');
                        lapTimeComparisonElement.style.display = 'flex';
                        lapTimeComparisonNameElement.style.display = 'flex';
                        refSector1TimeMS = timeTrialData.m_personalBestDataSet.m_sector1TimeInMS || -1;
                        // Calculate refSector2TimeMS using m_sector1TimeInMS and m_sector2TimeInMS, defaulting missing to 0
                        const s1TimeMS = timeTrialData.m_personalBestDataSet.m_sector1TimeInMS || 0;
                        const s2TimeMS = timeTrialData.m_personalBestDataSet.m_sector2TimeInMS || 0;
                        refSector2TimeMS = s1TimeMS + s2TimeMS;
                        refLastLapTimeMS = personalBestTime || -1;
                    } else {
                        lapTimeComparisonElement.style.display = 'none';
                        lapTimeComparisonNameElement.style.display = 'none';
                        refSector1TimeMS = -1;
                        refSector2TimeMS = -1;
                        refLastLapTimeMS = -1;
                    }
                }
            } else if (data.m_header.m_packetId === 11) {
                if (canUpdateReference && [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17].includes(sessionType)) {
                    if (data.m_carIdx === targetCarIdx && targetCarIdx !== -1) {
                        const historyData = data.m_lapHistoryData;
                        const bestLapNum = data.m_bestLapTimeLapNum;
                        if (historyData && bestLapNum > 0 && bestLapNum <= historyData.length) {
                            lapTimeComparisonName = getLastName((targetCarIdx === leaderCarIdx) ? 'LEADER' :
                                ([5, 10].includes(sessionType) ? `POS ${numActiveCars === 20 ? 15 : 16}` : 'POS 10'));
                            if ([15, 16, 17].includes(sessionType)) {
                                lapTimeComparisonName = getLastName('PERSONAL BEST');
                            } else {
                                lapTimeComparisonName = getLastName(participantNames[targetCarIdx] || 'UNKNOWN');
                            }
                            if ([15, 16, 17].includes(sessionType)) {
                                if (currentLapNum < 3) {
                                    lapTimeComparisonElement.style.display = 'none';
                                    lapTimeComparisonNameElement.style.display = 'none';
                                } else {
                                    lapTimeComparisonElement.style.display = 'flex';
                                    lapTimeComparisonNameElement.style.display = 'flex';
                                }
                            } else {
                                lapTimeComparisonElement.style.display = 'flex';
                                lapTimeComparisonNameElement.style.display = 'flex';
                            }
                            refSector1TimeMS = calculateSectorTime(historyData[bestLapNum - 1].m_sector1TimeMinutesPart, historyData[bestLapNum - 1].m_sector1TimeMSPart);
                            refSector2TimeMS = calculateCombinedSectorTime(
                                historyData[bestLapNum - 1].m_sector1TimeMinutesPart,
                                historyData[bestLapNum - 1].m_sector1TimeMSPart,
                                historyData[bestLapNum - 1].m_sector2TimeMinutesPart,
                                historyData[bestLapNum - 1].m_sector2TimeMSPart
                            );
                            refLastLapTimeMS = historyData[bestLapNum - 1].m_lapTimeInMS;
                        } else {
                            lapTimeComparisonElement.style.display = 'none';
                            lapTimeComparisonNameElement.style.display = 'none';
                            refSector1TimeMS = -1;
                            refSector2TimeMS = -1;
                            refLastLapTimeMS = -1;
                        }
                    }
                }
            }
        });

        updateLapDisplay();
        loadJsonFiles();
    </script>
</body>
</html>