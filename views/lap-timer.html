<!DOCTYPE html>
<html>
<head>
    <title>F1 Lap Timer Overlay</title>
    <link rel="stylesheet" href="/fonts.css">
    <link rel="stylesheet" href="/styles-lap-timer.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>
<body>
    <div class="overlay-container">
        <div class="position-layer">1</div>
        <div class="team-logo-layer"></div>
        <div class="driver-name-layer">VERSTAPPEN</div>
        <div class="tyre-compound-layer">S</div>
        <div id="timer-background"></div>
        <div id="sectors-background"></div>
        <div id="separator"></div>
        <div id="lap-time" class="lap-time-layer">1:34.4</div>
        <div id="last-lap-time" class="last-lap-time-layer">Last: --:--.-</div>
        <div id="best-lap-time" class="best-lap-time-layer">Best: --:--.-</div>
        <div id="lap-time-comparison" class="lap-time-comparison-layer">1:39.432</div>
        <div id="lap-time-comparison-name" class="lap-time-comparison-name-layer">MAX VERSTAPPEN</div>
        <div id="sector-line"></div>
        <div id="sector1-text" class="sector1-text-layer">S1</div>
        <div id="sector2-text" class="sector2-text-layer">S2</div>
        <div id="sector3-text" class="sector3-text-layer">S3</div>
    </div>
    <script>
        const socket = io();
        const lapTimeElement = document.getElementById('lap-time');
        const lastLapTimeElement = document.getElementById('last-lap-time');
        const bestLapTimeElement = document.getElementById('best-lap-time');
        const lapTimeComparisonElement = document.getElementById('lap-time-comparison');
        const lapTimeComparisonNameElement = document.getElementById('lap-time-comparison-name');
        const sector1TextElement = document.getElementById('sector1-text');
        const sector2TextElement = document.getElementById('sector2-text');
        const sector3TextElement = document.getElementById('sector3-text');
        const positionElement = document.querySelector('.position-layer');
        const driverNameElement = document.querySelector('.driver-name-layer');
        const tyreCompoundElement = document.querySelector('.tyre-compound-layer');

        let currentLapTime = '1:34.4';
        let lastLapTime = '--:--.-';
        let bestLapTime = '--:--.-';
        let lapTimeComparison = '1:39.432';
        let lapTimeComparisonName = 'MAX VERSTAPPEN';
        let position = '1';
        let driverName = 'VERSTAPPEN';
        let tyreCompound = 'S';
        let sessionType = 0; // Default to unknown session

        function formatTime(milliseconds) {
            if (milliseconds < 10000) {
                const seconds = Math.floor(milliseconds / 1000);
                const ms = Math.floor(milliseconds % 1000 / 100); // One digit for milliseconds
                return `${seconds}.${ms}`;
            } else if (milliseconds < 60000) {
                const seconds = Math.floor(milliseconds / 1000);
                const ms = Math.floor(milliseconds % 1000 / 100); // One digit for milliseconds
                return `${String(seconds).padStart(2, '0')}.${ms}`;
            } else {
                const minutes = Math.floor(milliseconds / 60000);
                const seconds = Math.floor((milliseconds % 60000) / 1000);
                const ms = Math.floor(milliseconds % 1000 / 100); // One digit for milliseconds
                return `${minutes}:${String(seconds).padStart(2, '0')}.${ms}`;
            }
        }

        function formatComparisonTime(milliseconds) {
            if (milliseconds < 10000) {
                const seconds = Math.floor(milliseconds / 1000);
                const ms = milliseconds % 1000;
                return `${seconds}.${String(ms).padStart(3, '0')}`;
            } else {
                const minutes = Math.floor(milliseconds / 60000);
                const seconds = Math.floor((milliseconds % 60000) / 1000);
                const ms = milliseconds % 1000;
                return `${minutes}:${seconds < 10 ? seconds : String(seconds).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
            }
        }

        function updateLapDisplay() {
            lapTimeElement.textContent = currentLapTime;
            lastLapTimeElement.textContent = `Last: ${lastLapTime}`;
            bestLapTimeElement.textContent = `Best: ${bestLapTime}`;
            lapTimeComparisonElement.textContent = lapTimeComparison;
            lapTimeComparisonNameElement.textContent = lapTimeComparisonName;
            sector1TextElement.textContent = 'S1';
            sector2TextElement.textContent = 'S2';
            sector3TextElement.textContent = 'S3';
            positionElement.textContent = position;
            driverNameElement.textContent = driverName;
            tyreCompoundElement.textContent = tyreCompound;

            // Adjust lap time position based on time
            if (currentLapTime.includes(':')) {
                const [minutes] = currentLapTime.split(':').map(Number);
                if (minutes >= 1) {
                    lapTimeElement.style.left = '38px'; // 60 seconds and over
                } else {
                    lapTimeElement.style.left = '65px'; // Default position for < 60 seconds
                }
            } else if (parseInt(currentLapTime) < 10) {
                lapTimeElement.style.left = '115px'; // Less than 10 seconds
            } else {
                lapTimeElement.style.left = '65px'; // Default position for 10-59 seconds
            }
        }

        socket.on('f1_data', (data) => {
            if (data.m_header.m_packetId === 2) { // Lap Data Packet
                const playerIndex = data.m_header.m_playerCarIndex;
                const lapData = data.m_lapData[playerIndex];

                if (lapData) {
                    // Current lap time in milliseconds
                    const newLapTime = lapData.m_currentLapTimeInMS;
                    if (newLapTime > 0) {
                        currentLapTime = formatTime(newLapTime);
                    }

                    // Last lap time
                    const lastLapTimeMS = lapData.m_lastLapTimeInMS;
                    if (lastLapTimeMS > 0) {
                        lastLapTime = formatTime(lastLapTimeMS);
                    }

                    // Best lap time (assuming m_bestLapTimeInMS is available)
                    const bestLapTimeMS = lapData.m_bestLapTimeInMS || 0;
                    if (bestLapTimeMS > 0 && (bestLapTimeMS < (lapData.m_lastLapTimeInMS || Infinity))) {
                        bestLapTime = formatTime(bestLapTimeMS);
                    }

                    // Placeholder for dynamic data
                    position = lapData.m_carPosition || '1'; // Example, adjust based on data
                    driverName = 'VERSTAPPEN'; // Replace with dynamic data later
                    tyreCompound = 'S'; // Replace with dynamic data later

                    updateLapDisplay();

                    // Flash effect on new lap
                    if (lastLapTime !== '--:--.-') {
                        anime({
                            targets: lapTimeElement,
                            color: ['#ffffff', '#00ff00', '#ffffff'],
                            duration: 500,
                            easing: 'easeInOutQuad'
                        });
                    }
                }
            } else if (data.m_header.m_packetId === 1) { // Session Data Packet
                sessionType = data.m_sessionType; // Update session type from Packet ID 1
            } else if (data.m_header.m_packetId === 14) { // Time Trial Packet
                const playerIndex = data.m_header.m_playerCarIndex;
                const timeTrialData = data;

                if (timeTrialData) {
                    const personalBestTime = timeTrialData.m_personalBestDataSet.m_lapTimeInMS;

                    if (sessionType === 18) { // Time Trial session
                        if (personalBestTime != null && personalBestTime > 0) {
                            lapTimeComparison = formatComparisonTime(personalBestTime);
                            lapTimeComparisonName = 'PERSONAL BEST';
                            lapTimeComparisonElement.style.display = 'flex';
                            lapTimeComparisonNameElement.style.display = 'flex';
                            updateLapDisplay();
                        } else {
                            lapTimeComparisonElement.style.display = 'none';
                            lapTimeComparisonNameElement.style.display = 'none';
                        }
                    } else {
                        lapTimeComparison = '1:39.432'; // Placeholder text
                        lapTimeComparisonName = 'MAX VERSTAPPEN'; // Placeholder text
                        lapTimeComparisonElement.style.display = 'flex';
                        lapTimeComparisonNameElement.style.display = 'flex';
                        updateLapDisplay();
                    }
                }
            }
        });

        // Initial display
        updateLapDisplay();
    </script>
</body>
</html>