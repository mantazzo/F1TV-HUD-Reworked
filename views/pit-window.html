<!DOCTYPE html>
<html>
<head>
    <title>F1 Pit Window Overlay</title>
    <link rel="stylesheet" href="/fonts.css">
    <link rel="stylesheet" href="/styles-pit-window.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="overlay-container">
        <!-- Background -->
        <div class="pw-background"></div>
        
        <!-- Compound Section -->
        <div class="compound-section">
            <div class="compound-oval"></div>
            <div class="compound-name">NO DATA</div>
            <div class="compound-decoration"></div>
        </div>
        
        <!-- Current Tyre Labels -->
        <div class="current-label">CURRENT</div>
        <div class="tyre-label">TYRE</div>
        
        <!-- Pit Window Section -->
        <div class="pit-window-section">
            <div class="pit-window-background"></div>
            <div class="pit-window-borders">
                <div class="border-top-right"></div>
                <div class="border-bottom-left"></div>
            </div>
            <div class="pit-window-label">PIT WINDOW</div>
            <div class="pit-window-content">
                <div class="lap-label">LAP</div>
                <div class="lap-values">N/A</div>
            </div>
        </div>
        
        <!-- Top Gradient -->
        <div class="top-gradient"></div>
        
        <!-- AWS Banner -->
        <div class="aws-banner">
            <div class="aws-background"></div>
            <div class="aws-text"></div>
        </div>
    </div>
    
    <script>
        const socket = io();
        socket.emit('identify', 'Pit Window');
        
        const overlayContainer = document.querySelector('.overlay-container');
        const compoundOval = document.querySelector('.compound-oval');
        const compoundName = document.querySelector('.compound-name');
        const compoundDecoration = document.querySelector('.compound-decoration');
        const lapValues = document.querySelector('.lap-values');
        const borderTopRight = document.querySelector('.border-top-right');
        const borderBottomLeft = document.querySelector('.border-bottom-left');
        const pitWindowLabel = document.querySelector('.pit-window-label');
        const pitWindowContent = document.querySelector('.pit-window-content');
        
        // State variables
        let currentCompound = '';
        let pitWindowIdeal = 0;
        let pitWindowLatest = 0;
        let currentLap = 0;
        let playerIndex = null;
        
        // Auto display configuration
        let autoDisplayEnabled = false;
        let autoMode = 'none';
        let autoDuration = 15000; // Defaults to 15 seconds, can be changed manually in OverlayConfig.json
        let autoHideTimer = null;
        let lastAutoShowLap = -1; // Track which lap triggered auto-show to avoid repeated triggers
        let previousVisibility = false; // Track previous visibility state
        let previousAutoDisplay = false; // Track previous auto display state
        
        // Compound mapping for visual tyres
        const COMPOUND_VISUAL = {
            16: 'SOFT',
            17: 'MEDIUM',
            18: 'HARD',
            7: 'INTER',
            8: 'WET'
        };
        
        // Compound colors for decorations
        const COMPOUND_COLORS = {
            'SOFT': '#EC1C24',  // Red
            'MEDIUM': '#FFD604',  // Yellow/Gold
            'HARD': '#F0F0EC',  // White
            'INTER': '#31AF49',  // Green
            'WET': '#0073AD'  // Blue/Turquoise
        };
        
        // Helper function to show overlay with animation
        function showOverlay() {
            overlayContainer.classList.add('visible');
            
            // Trigger blinking animation
            pitWindowContent.classList.remove('blink-active');
            void pitWindowContent.offsetWidth; // Force reflow
            pitWindowContent.classList.add('blink-active');
            setTimeout(() => {
                pitWindowContent.classList.remove('blink-active');
            }, 2000);
        }
        
        // Helper function to hide overlay
        function hideOverlay() {
            overlayContainer.classList.remove('visible');
            
            // Clear any pending auto-hide timer
            if (autoHideTimer) {
                clearTimeout(autoHideTimer);
                autoHideTimer = null;
            }
        }
        
        // Handle overlay visibility from controller
        socket.on('overlay_config', (config) => {
            if (config.overlays && config.overlays['pit-window']) {
                const pitWindowConfig = config.overlays['pit-window'];
                
                // Update auto display settings
                const newAutoDisplay = pitWindowConfig.autoDisplay === true;
                autoMode = pitWindowConfig.autoMode || 'none';
                autoDuration = pitWindowConfig.autoDuration || 15000;
                
                // Handle manual visibility toggle - only trigger show/hide if visibility actually changed
                const newVisibility = pitWindowConfig.visible === true;
                
                if (newVisibility !== previousVisibility) {
                    previousVisibility = newVisibility;
                    
                    if (newVisibility) {
                        showOverlay();
                        
                        // If auto display is enabled, start auto-hide timer
                        if (newAutoDisplay) {
                            if (autoHideTimer) clearTimeout(autoHideTimer);
                            autoHideTimer = setTimeout(() => {
                                hideOverlay();
                                // Note: Don't update previousVisibility here - keep it true
                                // so that changing settings doesn't re-trigger the overlay
                            }, autoDuration);
                        }
                    } else {
                        hideOverlay();
                    }
                } 
                // Handle edge case: auto display was just enabled while overlay is already visible
                else if (newAutoDisplay !== previousAutoDisplay && newAutoDisplay === true && previousVisibility === true) {
                    // Start auto-hide timer since overlay is showing but timer wasn't running
                    if (autoHideTimer) clearTimeout(autoHideTimer);
                    autoHideTimer = setTimeout(() => {
                        hideOverlay();
                    }, autoDuration);
                }
                
                // Update auto display state tracking
                autoDisplayEnabled = newAutoDisplay;
                previousAutoDisplay = newAutoDisplay;
            }
        });
        
        // Update compound display
        function updateCompound(visualCompound) {
            const compound = COMPOUND_VISUAL[visualCompound] || 'NO DATA';
            
            if (currentCompound !== compound) {
                currentCompound = compound;
                
                // Update text
                compoundName.textContent = compound;
                
                // Update oval background image
                const imagePath = `/images/pit-window/${compound === 'INTER' ? 'Inter' : compound.charAt(0) + compound.slice(1).toLowerCase()}.png`;
                compoundOval.style.backgroundImage = `url('${imagePath}')`;
                
                // Get color for this compound
                const compoundColor = COMPOUND_COLORS[compound] || '#EBD25F';
                
                // Update decoration border color
                compoundDecoration.style.borderColor = compoundColor;
                
                // Update pit window borders
                borderTopRight.style.borderColor = compoundColor;
                borderBottomLeft.style.borderColor = compoundColor;
                
                // Update pit window label color
                pitWindowLabel.style.color = compoundColor;
                
                // Update lap values color
                lapValues.style.color = compoundColor;
                
                console.log('[PitWindow] Compound updated:', compound, 'Color:', compoundColor);
            }
        }
        
        // Update pit window display
        function updatePitWindow(idealLap, latestLap) {
            if (idealLap === 0 && latestLap === 0) {
                lapValues.textContent = 'N/A';
            } else {
                lapValues.textContent = `${idealLap}-${latestLap}`;
                
                // Trigger blinking animation if overlay is visible
                if (overlayContainer.classList.contains('visible')) {
                    // Remove class if already present to restart animation
                    pitWindowContent.classList.remove('blink-active');
                    // Force reflow to restart animation
                    void pitWindowContent.offsetWidth;
                    // Add class to trigger animation
                    pitWindowContent.classList.add('blink-active');
                    
                    // Remove class after animation completes (5 cycles Ã— 400ms = 2000ms)
                    setTimeout(() => {
                        pitWindowContent.classList.remove('blink-active');
                    }, 2000);
                }
            }
        }
        
        // Handle F1 data packets
        socket.on('f1_data', (data) => {
            const packetId = data.m_header.m_packetId;
            
            if (packetId === 1) {
                // Session packet - pit window data
                const idealLap = data.m_pitStopWindowIdealLap || 0;
                const latestLap = data.m_pitStopWindowLatestLap || 0;
                
                if (pitWindowIdeal !== idealLap || pitWindowLatest !== latestLap) {
                    pitWindowIdeal = idealLap;
                    pitWindowLatest = latestLap;
                    updatePitWindow(idealLap, latestLap);
                }
                // TODO: Session tracking? The pit window values only work in race sessions, so maybe it would be best to make sure we don't show the overlay at all in sessions other than race?
                // But then again, we already show "N/A" when the lap values are 0, so this could remain as showing the current tyre compound instead in other sessions
            } else if (packetId === 2) {
                // Lap Data packet - track player's current lap
                if (playerIndex === null) {
                    playerIndex = data.m_header.m_playerCarIndex;
                }
                
                if (data.m_lapData && data.m_lapData[playerIndex]) {
                    const newLap = data.m_lapData[playerIndex].m_currentLapNum || 0;
                    
                    // Only process if lap changed
                    if (newLap !== currentLap && newLap > 0) {
                        currentLap = newLap;
                        
                        // Check if we should auto-show the overlay
                        if (autoDisplayEnabled && autoMode !== 'none' && pitWindowIdeal > 0) {
                            let shouldShow = false;
                            
                            // Determine if current lap matches auto-show criteria
                            if (autoMode === 'idealLap-1' && currentLap === (pitWindowIdeal - 1)) {
                                shouldShow = true;
                            } else if (autoMode === 'idealLap' && currentLap === pitWindowIdeal) {
                                shouldShow = true;
                            } else if (autoMode === 'both' && (currentLap === (pitWindowIdeal - 1) || currentLap === pitWindowIdeal)) {
                                shouldShow = true;
                            }
                            
                            // Show overlay if criteria met and not already shown for this lap
                            if (shouldShow && lastAutoShowLap !== currentLap) {
                                lastAutoShowLap = currentLap;
                                showOverlay();
                                previousVisibility = true; // Update state for auto-show
                                
                                // Start auto-hide timer
                                if (autoHideTimer) clearTimeout(autoHideTimer);
                                autoHideTimer = setTimeout(() => {
                                    hideOverlay();
                                    // Note: Don't update previousVisibility here - keep it true
                                    // so that changing settings doesn't re-trigger the overlay
                                }, autoDuration);
                            }
                        }
                    }
                }
            } else if (packetId === 7) {
                // Car Status packet - get player's tyre compound
                const playerIdx = data.m_header.m_playerCarIndex;
                
                if (data.m_carStatusData && data.m_carStatusData[playerIdx]) {
                    const visualCompound = data.m_carStatusData[playerIdx].m_visualTyreCompound;
                    updateCompound(visualCompound);
                }
            }
        });
        
        // Initialize with placeholder
        updatePitWindow(0, 0);
        // Set default compound oval image (Medium) for visibility, text will remain "NO DATA"
        compoundOval.style.backgroundImage = "url('/images/pit-window/Medium.png')";
    </script>
</body>
</html>
